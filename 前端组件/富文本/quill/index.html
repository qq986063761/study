<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®Œæ•´åŠŸèƒ½æ¼”ç¤º</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    #editor {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 400px;
    }
    
    .ql-editor {
      min-height: 400px;
      font-size: 16px;
      line-height: 1.6;
    }
    
    .ql-toolbar {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    
    .ql-container {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }

    /* è‡ªå®šä¹‰å­—ä½“å¤§å°æ ·å¼ */
    .ql-editor .ql-size-12px { font-size: 12px; }
    .ql-editor .ql-size-14px { font-size: 14px; }
    .ql-editor .ql-size-16px { font-size: 16px; }
    .ql-editor .ql-size-18px { font-size: 18px; }
    .ql-editor .ql-size-20px { font-size: 20px; }
    .ql-editor .ql-size-24px { font-size: 24px; }
    .ql-editor .ql-size-28px { font-size: 28px; }
    .ql-editor .ql-size-32px { font-size: 32px; }

    /* è‡ªå®šä¹‰å­—ä½“å¤§å°ä¸‹æ‹‰èœå•æ˜¾ç¤ºæ–‡æœ¬ */
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="8px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="8px"]::before {
      content: '8px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="10px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="10px"]::before {
      content: '10px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="12px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="12px"]::before {
      content: '12px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="14px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="14px"]::before {
      content: '14px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="16px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="16px"]::before {
      content: '16px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="18px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="18px"]::before {
      content: '18px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="20px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="20px"]::before {
      content: '20px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="24px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="24px"]::before {
      content: '24px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="28px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="28px"]::before {
      content: '28px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="32px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="32px"]::before {
      content: '32px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="36px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="36px"]::before {
      content: '36px';
    }
    .ql-snow .ql-picker.ql-size .ql-picker-item[data-value="48px"]::before,
    .ql-snow .ql-picker.ql-size .ql-picker-label[data-value="48px"]::before {
      content: '48px';
    }

    /* è‡ªå®šä¹‰æ ·å¼èœå•æ ·å¼ */
    .custom-style-picker {
      position: relative;
      display: inline-block;
      margin: 0 2px;
    }

    .custom-style-picker button {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 13px;
      color: #444;
      transition: all 0.2s ease;
    }

    .custom-style-picker button:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    .custom-style-picker button:active {
      background: #e0e0e0;
    }

    .custom-style-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 120px;
      display: none;
    }

    .custom-style-dropdown.show {
      display: block;
    }

    .custom-style-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }

    .custom-style-item:last-child {
      border-bottom: none;
    }

    .custom-style-item:hover {
      background-color: #f5f5f5;
    }

    .custom-style-item.active {
      background-color: #e3f2fd;
      color: #1976d2;
    }


    /* è‡ªå®šä¹‰sizeæ ·å¼ - æ‰©å±•æ›´å¤šå­—ä½“å¤§å°é€‰é¡¹ */
    .ql-editor .ql-size-8px { font-size: 8px; }
    .ql-editor .ql-size-10px { font-size: 10px; }
    .ql-editor .ql-size-36px { font-size: 36px; }
    .ql-editor .ql-size-48px { font-size: 48px; }

    /* å®Œå…¨è‡ªå®šä¹‰å·¥å…·æ æ ·å¼ */
    #custom-toolbar {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px 8px 0 0;
      padding: 8px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: #ddd;
      margin: 0 4px;
    }

    .toolbar-button {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 13px;
      color: #444;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 32px;
      justify-content: center;
    }

    .toolbar-button:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .toolbar-button:active {
      background: #e0e0e0;
    }

    .toolbar-button.active {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1976d2;
    }

    .button-icon {
      font-weight: bold;
      font-size: 14px;
    }

    .button-text {
      font-size: 12px;
    }

    .dropdown-arrow {
      font-size: 10px;
      color: #666;
    }

    /* ä¸‹æ‹‰èœå•æ ·å¼ */
    .toolbar-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 120px;
      display: none;
      margin-top: 2px;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      font-size: 13px;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background-color: #f5f5f5;
    }

    .dropdown-item.active {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ */
    .color-palette.show {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      padding: 8px;
      min-width: 160px;
    }

    .color-item {
      width: 24px;
      height: 24px;
      border-radius: 3px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #666;
      flex-shrink: 0;
    }

    .color-item:hover {
      transform: scale(1.1);
      border-color: #999;
    }

    .color-preview {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ddd;
    }

    /* @ æåŠæ ·å¼ */
    .ql-editor .mention {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 500;
      cursor: pointer;
    }

    .ql-editor .mention:hover {
      background-color: #bbdefb;
    }

    /* ç”¨æˆ·é€‰æ‹©ä¸‹æ‹‰èœå•æ ·å¼ */
    .mention-dropdown {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 2000;
      max-height: 200px;
      overflow-y: auto;
      min-width: 200px;
      display: none;
    }

    .mention-dropdown.show {
      display: block;
    }

    .mention-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mention-item:last-child {
      border-bottom: none;
    }

    .mention-item:hover,
    .mention-item.highlighted {
      background-color: #e3f2fd;
    }

    .mention-item .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .mention-item .name {
      flex: 1;
      font-size: 14px;
      color: #333;
    }

    .mention-item .dept {
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  
  <!-- å®Œå…¨è‡ªå®šä¹‰å·¥å…·æ  -->
  <div id="custom-toolbar">
    <!-- æ–‡æœ¬æ ¼å¼ç»„ -->
    <div class="toolbar-group">
      <div class="toolbar-dropdown" >
        <button class="toolbar-button dropdown-trigger" data-action="header" title="æ ‡é¢˜">
          <span class="button-text">æ ‡é¢˜</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-menu">
          <div class="dropdown-item" data-value="">æ™®é€šæ–‡æœ¬</div>
          <div class="dropdown-item" data-value="1">æ ‡é¢˜1</div>
          <div class="dropdown-item" data-value="2">æ ‡é¢˜2</div>
          <div class="dropdown-item" data-value="3">æ ‡é¢˜3</div>
          <div class="dropdown-item" data-value="4">æ ‡é¢˜4</div>
          <div class="dropdown-item" data-value="5">æ ‡é¢˜5</div>
          <div class="dropdown-item" data-value="6">æ ‡é¢˜6</div>
        </div>
      </div>
      
      <div class="toolbar-dropdown" >
        <button class="toolbar-button dropdown-trigger" data-action="size" title="å­—å·">
          <span class="button-text">å­—å·</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-menu">
          <div class="dropdown-item" data-value="8px">8px</div>
          <div class="dropdown-item" data-value="10px">10px</div>
          <div class="dropdown-item" data-value="12px">12px</div>
          <div class="dropdown-item" data-value="14px">14px</div>
          <div class="dropdown-item" data-value="16px">16px</div>
          <div class="dropdown-item" data-value="18px">18px</div>
          <div class="dropdown-item" data-value="20px">20px</div>
          <div class="dropdown-item" data-value="24px">24px</div>
          <div class="dropdown-item" data-value="28px">28px</div>
          <div class="dropdown-item" data-value="32px">32px</div>
          <div class="dropdown-item" data-value="36px">36px</div>
          <div class="dropdown-item" data-value="48px">48px</div>
        </div>
      </div>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- æ–‡æœ¬æ ·å¼ç»„ -->
    <div class="toolbar-group">
      <button class="toolbar-button" data-action="bold" title="ç²—ä½“">
        <span class="button-icon">B</span>
      </button>
      <button class="toolbar-button" data-action="italic" title="æ–œä½“">
        <span class="button-icon">I</span>
      </button>
      <button class="toolbar-button" data-action="underline" title="ä¸‹åˆ’çº¿">
        <span class="button-icon">U</span>
      </button>
      <button class="toolbar-button" data-action="strike" title="åˆ é™¤çº¿">
        <span class="button-icon">S</span>
      </button>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- é¢œè‰²ç»„ -->
    <div class="toolbar-group">
      <div class="toolbar-dropdown" >
        <button class="toolbar-button dropdown-trigger" data-action="color" title="æ–‡å­—é¢œè‰²">
          <span class="color-preview" style="background-color: #000;"></span>
          <span class="button-text">æ–‡å­—</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-menu color-palette">
          <div class="color-item" data-value="#000000" style="background-color: #000000;"></div>
          <div class="color-item" data-value="#333333" style="background-color: #333333;"></div>
          <div class="color-item" data-value="#666666" style="background-color: #666666;"></div>
          <div class="color-item" data-value="#999999" style="background-color: #999999;"></div>
          <div class="color-item" data-value="#cccccc" style="background-color: #cccccc;"></div>
          <div class="color-item" data-value="#ff0000" style="background-color: #ff0000;"></div>
          <div class="color-item" data-value="#00ff00" style="background-color: #00ff00;"></div>
          <div class="color-item" data-value="#0000ff" style="background-color: #0000ff;"></div>
          <div class="color-item" data-value="#ffff00" style="background-color: #ffff00;"></div>
          <div class="color-item" data-value="#ff00ff" style="background-color: #ff00ff;"></div>
          <div class="color-item" data-value="#00ffff" style="background-color: #00ffff;"></div>
          <div class="color-item" data-value="#ffa500" style="background-color: #ffa500;"></div>
        </div>
      </div>
      
      <div class="toolbar-dropdown" >
        <button class="toolbar-button dropdown-trigger" data-action="background" title="èƒŒæ™¯é¢œè‰²">
          <span class="color-preview" style="background-color: #ffff00;"></span>
          <span class="button-text">èƒŒæ™¯</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-menu color-palette">
          <div class="color-item" data-value="transparent" style="background-color: transparent; border: 1px solid #ccc;">æ— </div>
          <div class="color-item" data-value="#ffff00" style="background-color: #ffff00;"></div>
          <div class="color-item" data-value="#ffcccc" style="background-color: #ffcccc;"></div>
          <div class="color-item" data-value="#ccffcc" style="background-color: #ccffcc;"></div>
          <div class="color-item" data-value="#ccccff" style="background-color: #ccccff;"></div>
          <div class="color-item" data-value="#ffffcc" style="background-color: #ffffcc;"></div>
          <div class="color-item" data-value="#ffccff" style="background-color: #ffccff;"></div>
          <div class="color-item" data-value="#ccffff" style="background-color: #ccffff;"></div>
        </div>
      </div>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- å¯¹é½ç»„ -->
    <div class="toolbar-group">
      <div class="toolbar-dropdown" >
        <button class="toolbar-button dropdown-trigger" data-action="align" title="æ–‡æœ¬å¯¹é½">
          <span class="button-text">å¯¹é½</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-menu">
          <div class="dropdown-item" data-value="">å·¦å¯¹é½</div>
          <div class="dropdown-item" data-value="center">å±…ä¸­</div>
          <div class="dropdown-item" data-value="right">å³å¯¹é½</div>
          <div class="dropdown-item" data-value="justify">ä¸¤ç«¯å¯¹é½</div>
        </div>
      </div>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- åˆ—è¡¨ç»„ -->
    <div class="toolbar-group">
      <button class="toolbar-button" data-action="list" data-value="ordered" title="æœ‰åºåˆ—è¡¨">
        <span class="button-icon">1.</span>
      </button>
      <button class="toolbar-button" data-action="list" data-value="bullet" title="æ— åºåˆ—è¡¨">
        <span class="button-icon">â€¢</span>
      </button>
      <button class="toolbar-button" data-action="indent" data-value="-1" title="å‡å°‘ç¼©è¿›">
        <span class="button-icon">â†</span>
      </button>
      <button class="toolbar-button" data-action="indent" data-value="+1" title="å¢åŠ ç¼©è¿›">
        <span class="button-icon">â†’</span>
      </button>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- å…¶ä»–åŠŸèƒ½ç»„ -->
    <div class="toolbar-group">
      <button class="toolbar-button" data-action="blockquote" title="å¼•ç”¨">
        <span class="button-icon">"</span>
      </button>
      <button class="toolbar-button" data-action="code-block" title="ä»£ç å—">
        <span class="button-icon">&lt;/&gt;</span>
      </button>
      <button class="toolbar-button" data-action="link" title="é“¾æ¥">
        <span class="button-icon">ğŸ”—</span>
      </button>
      <button class="toolbar-button" data-action="image" title="å›¾ç‰‡">
        <span class="button-icon">ğŸ–¼</span>
      </button>
    </div>
    
    <!-- åˆ†éš”çº¿ -->
    <div class="toolbar-separator"></div>
    
    <!-- æ¸…ç†ç»„ -->
    <div class="toolbar-group">
      <button class="toolbar-button" data-action="clean" title="æ¸…é™¤æ ¼å¼">
        <span class="button-icon">ğŸ§¹</span>
      </button>
    </div>
  </div>
  
  <div id="editor">
    <h1>Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®Œæ•´åŠŸèƒ½æ¼”ç¤º</h1>
    <h2>æ”¯æŒçš„åŠŸèƒ½åŒ…æ‹¬ï¼š</h2>
    <ul>
      <li><strong>æ–‡æœ¬æ ¼å¼</strong>ï¼šæ ‡é¢˜ã€å­—ä½“ã€å­—å·</li>
      <li><strong>æ–‡æœ¬æ ·å¼</strong>ï¼šç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€åˆ é™¤çº¿</li>
      <li><strong>é¢œè‰²</strong>ï¼šæ–‡å­—é¢œè‰²ã€èƒŒæ™¯è‰²</li>
      <li><strong>å¯¹é½</strong>ï¼šå·¦å¯¹é½ã€å±…ä¸­ã€å³å¯¹é½ã€ä¸¤ç«¯å¯¹é½</li>
      <li><strong>åˆ—è¡¨</strong>ï¼šæœ‰åºåˆ—è¡¨ã€æ— åºåˆ—è¡¨ã€ç¼©è¿›</li>
      <li><strong>å…¶ä»–</strong>ï¼šå¼•ç”¨ã€ä»£ç å—ã€é“¾æ¥ã€å›¾ç‰‡ã€è§†é¢‘</li>
      <li><strong>@ æåŠ</strong>ï¼šè¾“å…¥ @ ç¬¦å·å¯ä»¥é€‰äººï¼Œè¯•è¯•è¾“å…¥ @ çœ‹çœ‹æ•ˆæœï¼</li>
    </ul>
    <blockquote>
      <p>è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—ï¼Œå±•ç¤ºå¼•ç”¨åŠŸèƒ½ã€‚</p>
    </blockquote>
    <pre><code>// è¿™æ˜¯ä»£ç å—
function hello() {
  console.log('Hello Quill!');
}</code></pre>
    <p>è¯•è¯•æ’å…¥ <a href="https://quilljs.com">é“¾æ¥</a> å’Œå›¾ç‰‡ï¼</p>
  </div>

  <!-- ç”¨æˆ·é€‰æ‹©ä¸‹æ‹‰èœå• -->
  <div id="mention-dropdown" class="mention-dropdown"></div>

  <script>
    console.log('Quill', Quill.imports, Quill);

    // æ³¨å†Œè‡ªå®šä¹‰å­—ä½“å¤§å°æ ¼å¼
    const SizeClass = Quill.import('attributors/class/size');
    const SizeStyle = Quill.import('attributors/style/size');
    
    // å®šä¹‰è‡ªå®šä¹‰å­—ä½“å¤§å°èŒƒå›´
    SizeClass.whitelist = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '28px', '32px', '36px', '48px'];
    SizeStyle.whitelist = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '28px', '32px', '36px', '48px'];
    
    // æ³¨å†Œè‡ªå®šä¹‰æ ¼å¼
    Quill.register(SizeClass, true);
    Quill.register(SizeStyle, true);

    // åˆ›å»ºè‡ªå®šä¹‰ Mention Blot
    const Inline = Quill.import('blots/inline');
    
    class MentionBlot extends Inline {
      static create(value) {
        const node = super.create();
        node.setAttribute('data-id', value.id);
        node.setAttribute('data-name', value.name);
        node.setAttribute('data-dept', value.dept || '');
        node.classList.add('mention');
        node.textContent = `@${value.name}`;
        return node;
      }

      static value(node) {
        return {
          id: node.getAttribute('data-id'),
          name: node.getAttribute('data-name'),
          dept: node.getAttribute('data-dept') || ''
        };
      }

      static formats(node) {
        return {
          id: node.getAttribute('data-id'),
          name: node.getAttribute('data-name'),
          dept: node.getAttribute('data-dept') || ''
        };
      }
    }
    
    MentionBlot.blotName = 'mention';
    MentionBlot.tagName = 'span';
    Quill.register(MentionBlot);

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: false  // å®Œå…¨ç¦ç”¨å†…ç½®å·¥å…·æ 
      },
      formats: [
        'header', 'size',
        'bold', 'italic', 'underline', 'strike',
        'color', 'background', 'script',
        'align', 'direction',
        'list', 'indent',
        'blockquote', 'code-block',
        'link', 'image', 'video',
        'mention'
      ]
    });

    // å®Œå…¨è‡ªå®šä¹‰å·¥å…·æ äº¤äº’é€»è¾‘
    class CustomToolbar {
      constructor(quill) {
        this.quill = quill;
        this.activeDropdown = null;
        this.init();
      }

      init() {
        this.bindEvents();
        this.updateButtonStates();
        
        // ç›‘å¬ç¼–è¾‘å™¨é€‰æ‹©å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
        this.quill.on('selection-change', (range) => {
          this.updateButtonStates();
        });
      }

      bindEvents() {
        const toolbar = document.getElementById('custom-toolbar');
        
        // ç»‘å®šæ‰€æœ‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        toolbar.addEventListener('click', (e) => {
          const button = e.target.closest('.toolbar-button');
          if (!button) return;
          
          const action = button.dataset.action;
          const value = button.dataset.value;

          if (['header', 'size', 'align', 'color', 'background'].includes(action)) {
            this.toggleDropdown(button);
          } else {
            this.executeAction(action, value);
          }
        });

        // ç»‘å®šä¸‹æ‹‰èœå•é¡¹ç‚¹å‡»äº‹ä»¶
        toolbar.addEventListener('click', (e) => {
          const item = e.target.closest('.dropdown-item, .color-item');
          if (!item) return;

          const dropdown = item.closest('.dropdown-menu');
          const button = dropdown.previousElementSibling;
          const action = button.dataset.action;
          const value = item.dataset.value;

          this.executeAction(action, value);
          this.closeDropdown();
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.toolbar-dropdown')) {
            this.closeDropdown();
          }
        });
      }

      toggleDropdown(button) {
        const dropdown = button.nextElementSibling;
        
        if (this.activeDropdown === dropdown) {
          this.closeDropdown();
        } else {
          this.closeDropdown();
          this.activeDropdown = dropdown;
          dropdown.classList.add('show');
        }
      }

      closeDropdown() {
        if (this.activeDropdown) {
          this.activeDropdown.classList.remove('show');
          this.activeDropdown = null;
        }
      }

      executeAction(action, value) {
        const range = this.quill.getSelection();
        
        switch (action) {
          case 'header':
            this.quill.format('header', value || false);
            break;
          case 'size':
            this.quill.format('size', value || false);
            break;
          case 'bold':
            this.quill.format('bold', !this.quill.getFormat().bold);
            break;
          case 'italic':
            this.quill.format('italic', !this.quill.getFormat().italic);
            break;
          case 'underline':
            this.quill.format('underline', !this.quill.getFormat().underline);
            break;
          case 'strike':
            this.quill.format('strike', !this.quill.getFormat().strike);
            break;
          case 'color':
            this.quill.format('color', value);
            break;
          case 'background':
            this.quill.format('background', value);
            break;
          case 'align':
            this.quill.format('align', value || false);
            break;
          case 'list':
            this.quill.format('list', value);
            break;
          case 'indent':
            const currentIndent = this.quill.getFormat().indent || 0;
            const newIndent = Math.max(0, currentIndent + parseInt(value));
            this.quill.format('indent', newIndent);
            break;
          case 'blockquote':
            this.quill.format('blockquote', !this.quill.getFormat().blockquote);
            break;
          case 'code-block':
            this.quill.format('code-block', !this.quill.getFormat()['code-block']);
            break;
          case 'link':
            this.insertLink();
            break;
          case 'image':
            this.insertImage();
            break;
          case 'clean':
            // è·å–å½“å‰é€‰æ‹©èŒƒå›´ï¼Œå¦‚æœæ²¡æœ‰é€‰ä¸­åˆ™ä½¿ç”¨å…‰æ ‡ä½ç½®
            const cleanRange = range || this.quill.getSelection();
            if (cleanRange) {
              // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ¸…é™¤é€‰ä¸­èŒƒå›´çš„æ ¼å¼
              if (cleanRange.length > 0) {
                this.quill.removeFormat(cleanRange.index, cleanRange.length);
              } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ¸…é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®çš„æ ¼å¼
                const currentFormat = this.quill.getFormat(cleanRange.index);
                // æ¸…é™¤æ‰€æœ‰æ ¼å¼
                Object.keys(currentFormat).forEach(format => {
                  if (format !== 'align' && format !== 'direction') {
                    this.quill.format(format, false);
                  }
                });
                // æ¸…é™¤å¯¹é½æ ¼å¼
                this.quill.format('align', false);
              }
            }
            break;
        }
        
        this.updateButtonStates();
      }

      insertLink() {
        const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:');
        if (url) {
          const range = this.quill.getSelection();
          if (range) {
            this.quill.formatText(range.index, range.length, 'link', url);
          }
        }
      }

      insertImage() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = () => {
          const file = input.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              const range = this.quill.getSelection();
              this.quill.insertEmbed(range.index, 'image', reader.result);
            };
            reader.readAsDataURL(file);
          }
        };
      }

      updateButtonStates() {
        const format = this.quill.getFormat();
        
        // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.toolbar-button').forEach(button => {
          const action = button.dataset.action;
          let isActive = false;

          switch (action) {
            case 'bold':
              isActive = !!format.bold;
              break;
            case 'italic':
              isActive = !!format.italic;
              break;
            case 'underline':
              isActive = !!format.underline;
              break;
            case 'strike':
              isActive = !!format.strike;
              break;
            case 'blockquote':
              isActive = !!format.blockquote;
              break;
            case 'code-block':
              isActive = !!format['code-block'];
              break;
          }

          button.classList.toggle('active', isActive);
        });

        // æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤ºæ–‡æœ¬
        this.updateDropdownTexts(format);
      }

      updateDropdownTexts(format) {
        // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
        const headerButton = document.querySelector('[data-action="header"] .button-text');
        if (headerButton) {
          const headerValue = format.header;
          headerButton.textContent = headerValue ? `æ ‡é¢˜${headerValue}` : 'æ ‡é¢˜';
        }

        // æ›´æ–°å­—å·æ˜¾ç¤º
        const sizeButton = document.querySelector('[data-action="size"] .button-text');
        if (sizeButton) {
          const sizeValue = format.size;
          sizeButton.textContent = sizeValue || 'å­—å·';
        }

        // æ›´æ–°å¯¹é½æ˜¾ç¤º
        const alignButton = document.querySelector('[data-action="align"] .button-text');
        if (alignButton) {
          const alignValue = format.align;
          const alignTexts = {
            '': 'å·¦å¯¹é½',
            'center': 'å±…ä¸­',
            'right': 'å³å¯¹é½',
            'justify': 'ä¸¤ç«¯å¯¹é½'
          };
          alignButton.textContent = alignTexts[alignValue] || 'å¯¹é½';
        }

        // æ›´æ–°é¢œè‰²é¢„è§ˆ
        const colorPreview = document.querySelector('[data-action="color"] .color-preview');
        if (colorPreview && format.color) {
          colorPreview.style.backgroundColor = format.color;
        }

        const bgPreview = document.querySelector('[data-action="background"] .color-preview');
        if (bgPreview && format.background) {
          bgPreview.style.backgroundColor = format.background;
        }
      }
    }

    // åˆå§‹åŒ–è‡ªå®šä¹‰å·¥å…·æ 
    const customToolbar = new CustomToolbar(quill);

    // @ æåŠåŠŸèƒ½
    class MentionHandler {
      constructor(quill) {
        this.quill = quill;
        this.mentionDropdown = document.getElementById('mention-dropdown');
        this.mentionStartIndex = null;
        this.searchText = '';
        this.selectedIndex = 0;
        this.userList = [
          { id: '1', name: 'å¼ ä¸‰', dept: 'æŠ€æœ¯éƒ¨' },
          { id: '2', name: 'æå››', dept: 'äº§å“éƒ¨' },
          { id: '3', name: 'ç‹äº”', dept: 'è®¾è®¡éƒ¨' },
          { id: '4', name: 'èµµå…­', dept: 'è¿è¥éƒ¨' },
          { id: '5', name: 'é’±ä¸ƒ', dept: 'æŠ€æœ¯éƒ¨' },
          { id: '6', name: 'å­™å…«', dept: 'äº§å“éƒ¨' },
          { id: '7', name: 'å‘¨ä¹', dept: 'è®¾è®¡éƒ¨' },
          { id: '8', name: 'å´å', dept: 'è¿è¥éƒ¨' }
        ];
        this.filteredUsers = [];
        this.init();
      }

      init() {
        // ç›‘å¬æ–‡æœ¬å˜åŒ–
        this.quill.on('text-change', (delta, oldDelta, source) => {
          if (source === 'user') {
            this.handleTextChange();
          }
        });

        // ç›‘å¬é€‰æ‹©å˜åŒ–
        this.quill.on('selection-change', (range) => {
          if (!range) {
            this.hideDropdown();
            return;
          }
          this.handleTextChange();
        });

        // é”®ç›˜äº‹ä»¶
        this.quill.root.addEventListener('keydown', (e) => {
          if (this.mentionDropdown.classList.contains('show')) {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredUsers.length - 1);
              this.updateDropdown();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
              this.updateDropdown();
            } else if (e.key === 'Enter' || e.key === 'Tab') {
              e.preventDefault();
              this.selectUser(this.filteredUsers[this.selectedIndex]);
            } else if (e.key === 'Escape') {
              e.preventDefault();
              this.hideDropdown();
            }
          }
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#mention-dropdown') && !e.target.closest('.ql-editor')) {
            this.hideDropdown();
          }
        });

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ä¸‹æ‹‰èœå•é¡¹çš„ç‚¹å‡»
        this.mentionDropdown.addEventListener('click', (e) => {
          const item = e.target.closest('.mention-item');
          if (item) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘ document çš„ click äº‹ä»¶
            const index = Array.from(this.mentionDropdown.children).indexOf(item);
            if (index >= 0 && index < this.filteredUsers.length) {
              console.log('click', this.filteredUsers[index], item);
              this.selectUser(this.filteredUsers[index]);
            }
          }
        });
      }

      handleTextChange() {
        const range = this.quill.getSelection();
        if (!range) return;

        const text = this.quill.getText(0, range.index);
        // æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡çš„åŒ¹é…
        const match = text.match(/@([^\s@]*)$/);

        if (match) {
          this.mentionStartIndex = range.index - match[0].length;
          this.searchText = match[1];
          this.filterUsers();
          this.showDropdown();
        } else {
          this.hideDropdown();
        }
      }

      filterUsers() {
        if (!this.searchText) {
          this.filteredUsers = this.userList;
        } else {
          const searchLower = this.searchText.toLowerCase();
          this.filteredUsers = this.userList.filter(user => 
            user.name.toLowerCase().includes(searchLower) ||
            (user.dept && user.dept.toLowerCase().includes(searchLower))
          );
        }
        this.selectedIndex = 0;
        this.updateDropdown();
      }

      showDropdown() {
        if (this.filteredUsers.length === 0) {
          this.hideDropdown();
          return;
        }

        const range = this.quill.getSelection();
        if (!range) return;

        // è·å–å…‰æ ‡ä½ç½®
        const bounds = this.quill.getBounds(range.index);
        const editorBounds = this.quill.container.getBoundingClientRect();
        
        this.mentionDropdown.style.top = (editorBounds.top + bounds.top + bounds.height + window.scrollY) + 'px';
        this.mentionDropdown.style.left = (editorBounds.left + bounds.left + window.scrollX) + 'px';
        this.mentionDropdown.classList.add('show');
      }

      hideDropdown() {
        this.mentionDropdown.classList.remove('show');
        this.mentionStartIndex = null;
        this.searchText = '';
        this.selectedIndex = 0;
      }

      updateDropdown() {
        this.mentionDropdown.innerHTML = '';
        
        this.filteredUsers.forEach((user, index) => {
          const item = document.createElement('div');
          item.className = 'mention-item' + (index === this.selectedIndex ? ' highlighted' : '');
          item.innerHTML = `
            <div class="avatar">${user.name.charAt(0)}</div>
            <div style="flex: 1;">
              <div class="name">${this.highlightText(user.name, this.searchText)}</div>
              ${user.dept ? `<div class="dept">${user.dept}</div>` : ''}
            </div>
          `;
          this.mentionDropdown.appendChild(item);
        });

        // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
        const highlightedItem = this.mentionDropdown.querySelector('.highlighted');
        if (highlightedItem) {
          highlightedItem.scrollIntoView({ block: 'nearest' });
        }
      }

      highlightText(text, search) {
        if (!search) return text;
        // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œæ”¯æŒä¸­æ–‡é«˜äº®
        const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedSearch})`, 'gi');
        return text.replace(regex, '<strong>$1</strong>');
      }

      selectUser(user) {
        if (!user || !this.mentionStartIndex) return;

        const range = this.quill.getSelection();
        if (!range) return;

        // åˆ é™¤ @ å’Œæœç´¢æ–‡æœ¬
        const deleteLength = range.index - this.mentionStartIndex;
        this.quill.deleteText(this.mentionStartIndex, deleteLength);

        // æ’å…¥æåŠ
        this.quill.insertText(this.mentionStartIndex, `@${user.name}`, 'mention', {
          id: user.id,
          name: user.name,
          dept: user.dept || ''
        });

        // ç§»åŠ¨å…‰æ ‡åˆ°æåŠä¹‹å
        this.quill.setSelection(this.mentionStartIndex + user.name.length + 1);

        this.hideDropdown();
      }
    }

    // åˆå§‹åŒ– @ æåŠåŠŸèƒ½
    const mentionHandler = new MentionHandler(quill);

    const str = '<h1>æ–°å¢å†…å®¹</h1>'
    // åœ¨ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆåï¼Œå°†å­—ç¬¦ä¸²å†…å®¹æ·»åŠ åˆ°ç°æœ‰å†…å®¹ä¹‹å
    setTimeout(() => {
      // è·å–å½“å‰å†…å®¹çš„é•¿åº¦
      const currentLength = quill.getLength();
      
      // å°† HTML å­—ç¬¦ä¸²æ’å…¥åˆ°ç¼–è¾‘å™¨æœ«å°¾
      // quill.clipboard.dangerouslyPasteHTML(currentLength - 1, str);

      // æ¢è¡Œæ’å…¥
      quill.insertText(currentLength - 1, '\n');
      quill.clipboard.dangerouslyPasteHTML(currentLength, str);
    }, 100);
  </script>
</body>
</html>