<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://at.alicdn.com/t/c/font_3536606_vty3twinj1.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <style>
    .editor-wrap .ql-toolbar,
    .editor-wrap .ql-container {
      background-color: #fff;
    }

    .editor-wrap.max {
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .editor-wrap.max .ql-toolbar {
      flex-shrink: 0;
    }

    .editor-wrap.max .ql-container {
      flex: 1;
      overflow: hidden;
    }

    .editor-at {
      color: blue;
    }

    .footer {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="editor-wrap">
    <div class="editor">初始化内容</div>
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
  </div>
  <div class="footer">
    <button id="getHtmlBtn">获取Html</button>
    <button id="getTextBtn">获取文本</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <script>
    // 注册自己的 html 格式
    const Block = Quill.import('blots/block')
    const BlockEmbed = Quill.import('blots/block/embed');
    const Inline = Quill.import('blots/inline');

    class atBtn extends Inline {
      static blotName = 'atBtn';
      static tagName = 'span';
      static className = 'editor-at';
      
      static create(value) {
        console.log('atBtn BlockEmbed', value)
        const node = super.create();
        // node.setAttribute('data-at', value)
        node.setAttribute('contenteditable', false);
        if (value.usrId) {
          node.dataset.usrid = value.usrId
        }
        if (value.label) {
          node.innerHTML = '@' + value.label
        }

        return node;
      }
      
      static formats(node) {
        return node.className
        // return node.getAttribute('data-at')
      }

      // format(name, value) {
      //   if (name === 'at' && value) {
      //     this.domNode.setAttribute('data-mention', value)
      //   } else {
      //     super.format(name, value)
      //   }
      // }

      static value(node) {
        console.log('atBtn value', node)
        return {
          label: node.innerHTML.replace('@', ''),
          usrId: node.dataset.usrid
        };
      }
    }

    Quill.register(atBtn);

    var quill = new Quill(document.querySelector('.editor'), {
      modules: {
        toolbar: {
          container: [
            // 分组
            [
              { 'font': [] }, // 字体风格
              { header: [] }, // 标题大小
              { 'size': [] }, // 字体大小
            ],
            [
              { 'color': [] }, // 前景色
              { 'background': [] }, // 背景色
            ],
            ['bold', 'italic', 'underline', 'strike'], // 文字装饰 
            [ 
              { 'align': [] }, // 对齐
              { 'list': 'ordered'}, { 'list': 'bullet' } // 列表
            ],
            ['blockquote', 'code-block'], // 代码格式
            ['link', 'image', 'video', 'formula'], // 媒体
            [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
            [{ 'indent': '-1'}, { 'indent': '+1' }], // 缩进
            ['clean'], // 清除格式
            ['imageBtn', 'tableBtn', 'atBtn', 'maxBtn'] // 自定义按钮
          ],
          handlers: {
            atBtn: () => {
              let htmlContent = '@人员'
              // const html = `<span class="editor-at" data-usrid="123">${htmlContent}</span>`
              const range = quill.getSelection()
              if (range) {
                // 用数据插入
                quill.insertEmbed(range.index, 'atBtn', {
                  label: htmlContent.replace('@', ''),
                  usrId: '123'
                })

                // 用 html 插入，好像有的属性上不去，还是用上面的 insertEmbed 吧
                // quill.clipboard.dangerouslyPasteHTML(range.index, html)
                // console.log('quill.getContents', quill.getContents())

                // 反向添加空格，因为 range.index 没变
                quill.insertText(range.index + htmlContent.length, '\u200B') // 空格

                // 光标
                // quill.focus({ preventScroll: true })
                quill.setSelection(range.index + htmlContent.length + 1)
              }
            },
            tableBtn: () => {
              const html = `
                <table border="1">
                  <tr>
                    <td>表头1</td>
                    <td>表头2</td>
                  </tr>
                  <tr>
                    <td>Cell 1</td>
                    <td>Cell 2</td>
                  </tr>
                </table>
              `
              const range = quill.getSelection()
              if (range) {
                quill.clipboard.dangerouslyPasteHTML(range.index, html)
              }
            },
            imageBtn: () => {
              // console.log('imageBtn')
              fileInput.click()
            },
            maxBtn: () => {
              let el = document.querySelector('.editor-wrap')
              if (el.className.includes(' max')) {
                el.className = el.className.replace(' max', '')
              } else {
                el.className += ' max'
              }
            }
          }
        }
      },
      placeholder: '请输入',
      // readOnly: true, // 只读
      theme: 'snow' // 主题
    })

    // var quill = new Quill(document.querySelector('.editor'), {
    //   modules: {
    //     toolbar: [['bold', 'italic'], ['underline', 'strike']]
    //   },
    //   theme: 'snow'
    // })
    console.log('初始化完成', quill)

    // 补充自定义按钮的功能
    let btn = document.querySelector('.editor-wrap .ql-imageBtn')
    btn.innerHTML = '<span class="iconfont icon-image"></span>'
    
    btn = document.querySelector('.editor-wrap .ql-maxBtn')
    btn.innerHTML = '<span class="iconfont icon-max"></span>'

    btn = document.querySelector('.editor-wrap .ql-tableBtn')
    btn.innerHTML = '<span class="iconfont icon-biaoge1"></span>'

    btn = document.querySelector('.editor-wrap .ql-atBtn')
    btn.innerHTML = '<span class="iconfont icon-at"></span>'

    // 监听文件选择，处理文件上传
    fileInput.addEventListener('change', (event) => {
      var file = event.target.files[0];
      if (file) {
        var reader = new FileReader()
        reader.onload = function(e) {
          var base64String = e.target.result;
          var range = quill.getSelection()
          quill.insertEmbed(range.index, 'image', base64String)
        }
        reader.readAsDataURL(file)
      }
      fileInput.value = ''
    })
    
    // 获取文本格式内容
    getTextBtn.onclick = () => {
      console.log('获取文本', quill.getText())
    }

    // 获取 html 格式内容
    getHtmlBtn.onclick = () => {
      console.log('获取html', quill.root.innerHTML)
    }
  </script>
</body>

</html>