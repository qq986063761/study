<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://at.alicdn.com/t/c/font_3536606_vty3twinj1.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <style>
    .editor-wrap .ql-toolbar,
    .editor-wrap .ql-container {
      background-color: #fff;
    }

    .editor-wrap .ql-toolbar button {
      width: unset;
    }

    .editor-wrap.max {
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .editor-wrap.max .ql-toolbar {
      flex-shrink: 0;
    }

    .editor-wrap.max .ql-container {
      flex: 1;
      overflow: hidden;
    }

    [data-list-custom="rocket"] .ql-ui:before {
      content: 'ğŸš€';
    }

    .editor-at {
      color: blue;
    }

    .footer {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="editor-wrap">
    <div class="editor">åˆå§‹åŒ–å†…å®¹</div>
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
  </div>
  <div class="footer">
    <button id="getHtmlBtn">è·å–Html</button>
    <button id="getTextBtn">è·å–æ–‡æœ¬</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <script>
    // æ³¨å†Œè‡ªå·±çš„ html å…ƒç´ 
    const Block = Quill.import('blots/block')
    const Container = Quill.import('blots/container')
    const BlockEmbed = Quill.import('blots/block/embed');
    const Inline = Quill.import('blots/inline');

    // @äºº
    class atBtn extends Inline {
      static blotName = 'atBtn';
      static tagName = 'span';
      static className = 'editor-at';
      
      static create(value) {
        // console.log('atBtn BlockEmbed', value)
        const node = super.create();
        // node.setAttribute('data-at', value)
        node.setAttribute('contenteditable', false);
        if (value.usrId) {
          node.dataset.usrid = value.usrId
        }
        if (value.label) {
          node.innerHTML = '@' + value.label
        }

        return node;
      }
      
      static formats(node) {
        return node.className
        // return node.getAttribute('data-at')
      }

      // format(name, value) {
      //   if (name === 'at' && value) {
      //     this.domNode.setAttribute('data-mention', value)
      //   } else {
      //     super.format(name, value)
      //   }
      // }

      static value(node) {
        // console.log('atBtn value', node)
        return {
          label: node.innerHTML.replace('@', ''),
          usrId: node.dataset.usrid
        };
      }
    }
    Quill.register(atBtn)

    // æ”¯æŒ fontsize
    class fontSize extends Inline {
      static blotName = 'fontSize';
      static tagName = 'span';
      
      static create(value) {
        const node = super.create();
        node.style.fontSize = value;
        return node;
      }
      
      static formats(node) {
        return node.style.fontSize;
      }
    }
    Quill.register(fontSize)

    // è‡ªå®šä¹‰åˆ—è¡¨
    class CustomListContainer extends Container {
      static blotName = 'customListContainer';
      static tagName = 'ol';
    }
    
    class CustomListItem extends Block {
      static blotName = 'customList';
      static tagName = 'li';

      static register() {
        Quill.register(CustomListContainer);
      }

      static create(value) {
        const node = super.create();
        node.className = 'custom-list-item'
        node.setAttribute('data-list-custom', value)
        return node;
      }
      
      static formats(node) {
        return node.getAttribute('data-list-custom')
      }

      constructor(scroll, domNode) {
        super(scroll, domNode);
        const ui = domNode.ownerDocument.createElement('span');
        const listEventHandler = (e) => {
          if (!scroll.isEnabled()) return;
          const format = this.statics.formats(domNode, scroll);
        };
        ui.addEventListener('mousedown', listEventHandler);
        ui.addEventListener('touchstart', listEventHandler);
        this.attachUI(ui);
      }

      format(name, value) {
        if (name === this.statics.blotName && value) {
          this.domNode.setAttribute('data-list-custom', value);
        } else {
          super.format(name, value);
        }
      }
    }
    CustomListContainer.allowedChildren = [CustomListItem];
    CustomListItem.requiredContainer = CustomListContainer;
    Quill.register(CustomListItem)
    
    // åˆå§‹åŒ–
    var quill = new Quill(document.querySelector('.editor'), {
      modules: {
        toolbar: {
          container: [
            // åˆ†ç»„
            [
              { 'font': [] }, // å­—ä½“é£æ ¼
              { header: [] }, // æ ‡é¢˜å¤§å°
              { 'size': [] }, // å­—ä½“å¤§å°
            ],
            [
              { 'color': [] }, // å‰æ™¯è‰²
              { 'background': [] }, // èƒŒæ™¯è‰²
            ],
            ['bold', 'italic', 'underline', 'strike'], // æ–‡å­—è£…é¥° 
            [ 
              { 'align': [] }, // å¯¹é½
              { 'list': 'ordered'}, { 'list': 'bullet' } // åˆ—è¡¨
            ],
            ['blockquote', 'code-block'], // ä»£ç æ ¼å¼
            ['link', 'image', 'video', 'formula'], // åª’ä½“
            [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
            [{ 'indent': '-1'}, { 'indent': '+1' }], // ç¼©è¿›
            ['clean'], // æ¸…é™¤æ ¼å¼
            ['imageBtn', 'tableBtn', 'atBtn', 'maxBtn', 'fontSizeBtn', 'fontColorBtn', 'listBtn'] // è‡ªå®šä¹‰æŒ‰é’®
          ],
          handlers: {
            // è‡ªå®šä¹‰åˆ—è¡¨
            listBtn: () => {
              const range = quill.getSelection();
              if (range) {
                // è·å–æ ¼å¼
                let data = quill.getFormat(range.index, range.length)
                // console.log('getFormat', data)
                
                // ç§»é™¤æ ¼å¼
                if (data.customList) {
                  quill.removeFormat(range.index, range.length)
                } else {
                  quill.formatLine(range.index, range.length, 'customList', 'rocket')
                }
              }
            },
            // å­—ä½“å¤§å°
            fontSizeBtn: () => {
              const range = quill.getSelection();
              if (range) {
                // è·å–æ ¼å¼
                let data = quill.getFormat(range.index, range.length)
                // console.log('getFormat', data)

                // è¿™é‡Œ '16px' æ˜¯ä½ æƒ³è®¾ç½®çš„å­—ä½“å¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ”¹
                quill.formatText(range.index, range.length, 'fontSize', data.fontSize === '32px' ? '26px' : '32px');
              }
            },
            // å­—ä½“é¢œè‰²
            fontColorBtn: () => {
              const range = quill.getSelection();
              if (range) {
                // è¿™é‡Œ '16px' æ˜¯ä½ æƒ³è®¾ç½®çš„å­—ä½“å¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ”¹
                quill.formatText(range.index, range.length, 'color', 'rgb(153, 51, 255)');
              }
            },
            // at
            atBtn: () => {
              let htmlContent = '@äººå‘˜'
              // const html = `<span class="editor-at" data-usrid="123">${htmlContent}</span>`
              const range = quill.getSelection()
              if (range) {
                // ç”¨æ•°æ®æ’å…¥
                quill.insertEmbed(range.index, 'atBtn', {
                  label: htmlContent.replace('@', ''),
                  usrId: '123'
                })

                // ç”¨ html æ’å…¥ï¼Œå¥½åƒæœ‰çš„å±æ€§ä¸Šä¸å»ï¼Œè¿˜æ˜¯ç”¨ä¸Šé¢çš„ insertEmbed å§
                // quill.clipboard.dangerouslyPasteHTML(range.index, html)
                // console.log('quill.getContents', quill.getContents())

                // åå‘æ·»åŠ ç©ºæ ¼ï¼Œå› ä¸º range.index æ²¡å˜
                quill.insertText(range.index + htmlContent.length, '\u200B') // ç©ºæ ¼

                // å…‰æ ‡
                // quill.focus({ preventScroll: true })
                quill.setSelection(range.index + htmlContent.length + 1)
              }
            },
            // è¡¨æ ¼
            tableBtn: () => {
              const html = `
                <p></p>
                <table border="1">
                  <tr>
                    <td>è¡¨å¤´1</td>
                    <td>è¡¨å¤´2</td>
                  </tr>
                  <tr>
                    <td>Cell 1</td>
                    <td>Cell 2</td>
                  </tr>
                </table>
                <p></p>
              `
              const range = quill.getSelection()
              if (range) {
                quill.clipboard.dangerouslyPasteHTML(range.index, html)
              }
            },
            // å›¾ç‰‡
            imageBtn: () => {
              // console.log('imageBtn')
              fileInput.click()
            },
            // æœ€å¤§åŒ–
            maxBtn: () => {
              let el = document.querySelector('.editor-wrap')
              if (el.className.includes(' max')) {
                el.className = el.className.replace(' max', '')
              } else {
                el.className += ' max'
              }
            }
          }
        }
      },
      placeholder: 'è¯·è¾“å…¥',
      // readOnly: true, // åªè¯»
      theme: 'snow' // ä¸»é¢˜
    })

    // var quill = new Quill(document.querySelector('.editor'), {
    //   modules: {
    //     toolbar: [['bold', 'italic'], ['underline', 'strike']]
    //   },
    //   theme: 'snow'
    // })
    console.log('åˆå§‹åŒ–å®Œæˆ', quill)

    // è¡¥å……è‡ªå®šä¹‰æŒ‰é’®çš„åŠŸèƒ½
    let btn = document.querySelector('.editor-wrap .ql-imageBtn')
    btn.innerHTML = '<span class="iconfont icon-image"></span>'
    
    btn = document.querySelector('.editor-wrap .ql-maxBtn')
    btn.innerHTML = '<span class="iconfont icon-max"></span>'

    btn = document.querySelector('.editor-wrap .ql-tableBtn')
    btn.innerHTML = '<span class="iconfont icon-biaoge1"></span>'

    btn = document.querySelector('.editor-wrap .ql-atBtn')
    btn.innerHTML = '<span class="iconfont icon-at"></span>'

    btn = document.querySelector('.editor-wrap .ql-fontSizeBtn')
    btn.innerHTML = 'æ”¹æ–‡å­—å¤§å°'

    btn = document.querySelector('.editor-wrap .ql-fontColorBtn')
    btn.innerHTML = 'æ”¹æ–‡å­—é¢œè‰²'

    btn = document.querySelector('.editor-wrap .ql-listBtn')
    btn.innerHTML = 'è‡ªå®šä¹‰åˆ—è¡¨'

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©ï¼Œå¤„ç†æ–‡ä»¶ä¸Šä¼ 
    fileInput.addEventListener('change', (event) => {
      var file = event.target.files[0];
      if (file) {
        var reader = new FileReader()
        reader.onload = function(e) {
          var base64String = e.target.result;
          var range = quill.getSelection()
          quill.insertEmbed(range.index, 'image', base64String)
        }
        reader.readAsDataURL(file)
      }
      fileInput.value = ''
    })
    
    // ç›‘å¬æ–‡æœ¬å˜åŒ–äº‹ä»¶
    quill.on('text-change', (delta, oldDelta, source) => {
      console.log('text-change', delta, oldDelta, source)
      
      // åªå¤„ç†æ¥è‡ªç”¨æˆ·è§¦å‘çš„å˜åŒ–
      if (source === 'user') {
        let index = 0; // ç»´æŠ¤å½“å‰æ“ä½œå½±å“çš„æ–‡æ¡£ä½ç½®

        // éå† Delta å¯¹è±¡çš„æ“ä½œ
        delta.ops.forEach(op => {
          if (op.insert) {
            // å¦‚æœæ’å…¥æ˜¯æ™®é€šæ–‡æœ¬ï¼Œæ›´æ–°ç´¢å¼•
            if (typeof op.insert === 'string') {
              index += op.insert.length;
            } else if (op.insert.image) {
              // åœ¨å‘ç°å›¾åƒæ’å…¥æ—¶è¿›è¡Œå¤„ç†
              const originalUrl = op.insert.image;
              const newUrl = 'https://zxb-online.oss-cn-beijing.aliyuncs.com/web/static/img/logo_white.svg'

              // ä½¿ç”¨ delete å’Œ insert ä»¥æ›¿æ¢ URL
              quill.deleteText(index, 1); // åˆ é™¤åŸå›¾åƒ
              quill.insertEmbed(index, 'image', newUrl); // æ’å…¥æ–°çš„å›¾åƒ

              index += 1; // å¢åŠ ä½ç½®æŒ‡é’ˆ
            }
          }
          // å¤„ç†ä¿ç•™å’Œå±æ€§
          if (op.retain) {
            index += op.retain;
          }
        })
      }
    })

    // ç›‘å¬ç¼–è¾‘å™¨äº‹ä»¶
    // let lastIsCustomListBr = false
    quill.root.addEventListener('keydown', function(event) {
      if (event.key === 'Backspace') {
        const range = quill.getSelection();

        // console.log('Backspace range', range)
        if (!range || range.index === 0) {
          // åˆ é™¤åˆ°ç¬¬ä¸€è¡Œçš„è‡ªå®šä¹‰åˆ—è¡¨ï¼Œå°±æ‰‹åŠ¨æ¸…é™¤
          let data = quill.getFormat(range.index, range.length)
          // console.log('getFormat', data)
          quill.removeFormat(range.index, range.length)
          return
        }

        // è·å–å…‰æ ‡ä¹‹å‰çš„å†…å®¹
        const beforeCursorContent = quill.getContents(0, range.index)
        const afterCursorContent = quill.getContents(range.index + 1)
        let ops = beforeCursorContent.ops;
        let lastOp = ops[ops.length - 1]
        let afterOpts = afterCursorContent.ops
        console.log('ops', ops, lastOp, afterOpts)

        // åˆ é™¤äº†æœ€åä¸€ä¸ªè‡ªå®šä¹‰åˆ—è¡¨ï¼Œåˆ™æ’å…¥æ–°è¡Œ
        // if (lastIsCustomListBr && !afterOpts.length) {
        //   quill.removeFormat(range.index + 1)
        //   quill.insertEmbed(range.index, 'block', true)
        // }
        // lastIsCustomListBr = lastOp.attributes && lastOp.attributes.customList && lastOp.insert === '\n'
        
        // åˆ é™¤@
        if (lastOp.attributes && lastOp.attributes.atBtn) {  
          quill.deleteText(range.index - lastOp.insert.length, lastOp.insert.length);
          event.preventDefault()
        }
      }
    })

    // è·å–æ–‡æœ¬æ ¼å¼å†…å®¹
    getTextBtn.onclick = () => {
      console.log('è·å–æ–‡æœ¬', quill.getText())
    }

    // è·å– html æ ¼å¼å†…å®¹
    getHtmlBtn.onclick = () => {
      console.log('è·å–html', quill.root.innerHTML)
    }
  </script>
</body>

</html>